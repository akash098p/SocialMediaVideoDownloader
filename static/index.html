<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Social Media Downloader</title>
<link rel="website icon" type="png" href="https://i.postimg.cc/qqxGwGCw/SMD.png">
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">

<div class="header">
  <div class="title-wrap">
    <img src="SMD.png" alt="SMD Logo" class="logo">
  <h3>Social Media Video Downloader</h3>
  </div>

  <div class="toggle" onclick="toggleTheme()" id="themeIcon">ðŸŒ™</div>
</div>

<!-- PLATFORM BAR -->
<div class="snackbar">
  <button class="youtube active" onclick="setPlatform('youtube',this)">
    <svg viewBox="0 0 24 24"><path d="M23.5 6.2s-.2-1.7-.9-2.4c-.8-.9-1.7-.9-2.1-1C17.4 2.5 12 2.5 12 2.5s-5.4 0-8.5.3c-.4.1-1.3.1-2.1 1-.7.7-.9 2.4-.9 2.4S0 8.1 0 10v1.9c0 1.9.5 3.8.5 3.8s.2 1.7.9 2.4c.8.9 1.9.9 2.4 1 1.7.2 7.2.3 7.2.3s5.4 0 8.5-.3c.4-.1 1.3-.1 2.1-1 .7-.7.9-2.4.9-2.4s.5-1.9.5-3.8V10c0-1.9-.5-3.8-.5-3.8zM9.5 14.5V7.5l6 3.5-6 3.5z"/></svg>
    YouTube
  </button>

  <button class="instagram" onclick="setPlatform('instagram',this)">
    <svg viewBox="0 0 24 24">
      <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5.5A4.5 4.5 0 1 0 16.5 12 4.5 4.5 0 0 0 12 7.5zm0 7.4A2.9 2.9 0 1 1 14.9 12 2.9 2.9 0 0 1 12 14.9zM17.5 6.5a1 1 0 1 1-1-1 1 1 0 0 1 1 1z"/>
    </svg>
    Instagram
  </button>

  <button class="facebook" onclick="setPlatform('facebook',this)">
    <svg viewBox="0 0 24 24"><path d="M22 12a10 10 0 1 0-11.5 9.9v-7H8v-3h2.5V9.5A3.5 3.5 0 0 1 14 6h2.5v3H14a1 1 0 0 0-1 1V12h3.5l-.5 3H13v7A10 10 0 0 0 22 12z"/></svg>
    Facebook
  </button>

  <button class="x" onclick="setPlatform('x',this)">
    <svg viewBox="0 0 24 24"><path d="M18.9 2H22l-7.4 8.5L23 22h-6.7l-5.2-6.7L5.6 22H2l7.9-9.1L1 2h6.8l4.7 6.1L18.9 2z"/></svg>
    X
  </button>
</div>

<div class="card">
  <div class="input-wrap">
    <input id="url" placeholder="Paste YouTube video URL" oninput="toggleClear()">
    <button class="clear-btn" id="clearBtn" onclick="clearInput()">Ã—</button>
  </div>
  <button class="main" onclick="fetchInfo()">Fetch</button>
</div>

<div id="info"></div>

<h3>Active Downloads</h3>
<div id="jobs"></div>

<h3>Download History</h3>
<div id="history"></div>

</div>

<div id="toast" class="toast"></div>

<script>
const API=/*for locally*/ "http://127.0.0.1:8000"; /* for wifi */ /*"http://172.23.13.130:8000";*/
let platform="youtube";
const activeJobs={};

/* ---------- THEME ---------- */
function toggleTheme(){
  document.body.classList.toggle("light");
  themeIcon.textContent =
    document.body.classList.contains("light") ? "â˜€" : "ðŸŒ™";
}

/* ---------- CLEAR INPUT ---------- */
function toggleClear(){
  clearBtn.classList.toggle("show", url.value.length>0);
}
function clearInput(){
  url.value="";
  toggleClear();
}

/* ---------- PLATFORM ---------- */
function setPlatform(p,btn){
  platform=p;
  document.querySelectorAll(".snackbar button")
    .forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");

  const placeholders={
    youtube:"Paste YouTube video URL",
    instagram:"Paste Instagram reel or post URL",
    facebook:"Paste Facebook video URL",
    x:"Paste X (Twitter) video URL"
  };
  url.placeholder=placeholders[p];
}

/* ---------- TOAST ---------- */
function showToast(msg){
  toast.textContent=msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2500);
}

/* ---------- FETCH INFO ---------- */
async function fetchInfo(){
  if(!url.value.trim()){
    showToast("Paste a video URL");
    return;
  }

  showToast("Fetching video info...");
  info.innerHTML=`
    <div class="card">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>
  `;

  const r=await fetch(`${API}/info?url=${encodeURIComponent(url.value)}`);
  const d=await r.json();

  let html=`<div class="card">
    <h3>${d.title}</h3>
    <img src="${d.thumbnail}" width="100%" style="border-radius:12px">
    <div class="grid">
  `;
  d.formats.forEach(f=>{
    html+=`<button class="main" onclick="start('${f.id}')">${f.label}</button>`;
  });
  html+=`</div></div>`;
  info.innerHTML=html;
}

/* ---------- START DOWNLOAD ---------- */
async function start(formatId){
  showToast("Download started");

  const r = await fetch(
    `${API}/download?url=${encodeURIComponent(url.value)}&format_id=${formatId}`,
    { method:"POST" }
  );
  const d = await r.json();

  createActiveJob(d.job_id);
}

/* ---------- ACTIVE JOB + HISTORY ---------- */
function createActiveJob(jobId){
  const div=document.createElement("div");
  div.className="card";
  div.id=`job-${jobId}`;

  div.innerHTML=`
    <div class="progress"><div></div></div>
  `;

  jobs.appendChild(div);
  const bar=div.querySelector(".progress div");

  const interval=setInterval(async()=>{
    const r=await fetch(`${API}/status/${jobId}`);
    const d=await r.json();

    bar.style.width=(d.progress||0)+"%";

    if(d.status==="done"){
      clearInterval(interval);
      div.remove();
      showToast("Download completed");

      // âœ… Download button
      const downloadCard=document.createElement("div");
      downloadCard.className="card";
      downloadCard.innerHTML=`
        <a href="${API}/file/${d.file}" target="_blank">
          â¬‡ Download
        </a>
      `;
      jobs.appendChild(downloadCard);

      // âœ… ADD TO HISTORY UI
      addToHistory(d.file);
    }
  },1000);

  activeJobs[jobId]={interval};
}

/* ---------- ADD TO HISTORY ---------- */
function addToHistory(file){
  if(document.getElementById(`hist-${file}`)) return;

  const div=document.createElement("div");
  div.className="card";
  div.id=`hist-${file}`;
  div.innerHTML=`
    <a href="${API}/file/${file}" target="_blank">${file}</a>
  `;
  history.prepend(div);
}

/* ---------- LOAD HISTORY ON PAGE LOAD ---------- */
async function loadHistory(){
  const r=await fetch(`${API}/history`);
  const h=await r.json();
  history.innerHTML="";
  h.forEach(addToHistory);
}

/* ---------- INIT ---------- */
loadHistory();
</script>
</body>
</html>
